# work-plan-2022-11-07

### 1. mca-video-ai 去AB依赖 - 完成 待上线
* video-ai去AB依赖, 依靠Dconfs做函数分流
 * 排期: 11月9号上线 
### 2. union 视频集熔断方案 - 方案设计中
    
1. 视频集接口QPS导致MySQL容量陡增,现在无保护措施
2. 增加熔断,保护DB即可
3. 排期: 11月3号-11月7号
### 3. 媒体库支持doby视频
> 目前进展: exchange测试通过- 待上线
* 预计上线时间: 2022-11-09
### 4. 媒体商单接入视频微博 - 联调中
> 配置邮件已发,等待确定各种配置是否生效?[视频类型新业务申请-媒体商单系统](media/16678014495690/%E8%A7%86%E9%A2%91%E7%B1%BB%E5%9E%8B%E6%96%B0%E4%B8%9A%E5%8A%A1%E7%94%B3%E8%AF%B7-%E5%AA%92%E4%BD%93%E5%95%86%E5%8D%95%E7%B3%BB%E7%BB%9F.xlsx)
    
1. [x] 审核,该业务视频是否推送给审核 - 佩文负责
2. [x] 视频水印,微博视频号 - 佩文确认
3. [ ] 版权保护, 非自制能进,是否侵权别人 - 和美娇确认
4. [x] 删微博同时删媒体库 - 和佳月确认
5. [ ] 进profile视频签 - union队里机
6. [x] 关注流/赞流  - 经佳月确认,已经没有了
7. [x] 投稿审核通过后进通知流 - 没有投稿行为,不存在此操作
8. [ ] 可推荐  - 未知
9. [ ] 统计视频播放量 - log-processor是否有限制
10. [ ] 统计作者播放量 - uid总播放量, 同视频签
11. [ ] 统计分类标签播放量(分类页) - 未知
12. [ ] 统计播放量 (数据中心报表) - 未知,需要问产品

### 5. 媒体库高可用核心资源梳理  
* [文档地址](https://wiki.api.weibo.com/zh/weibo_rd/weibo_rd_video/%E8%A7%86%E9%A2%91%E4%B8%AD%E5%8F%B0/wiki/%E4%B8%AD%E5%8F%B0%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90%E6%A2%B3%E7%90%86)
* 进展: mc各种资源机房信息, db高可用方案的熟悉

### 6. magma后台替换output bug修复

* 替换接口调用参数过长导致调用接口失败

### 7. MultiDimension多维库数据结构定义
> 源源不断的理解数据保存到媒体库,对type,group使用不规范会导致写入的数据没有用处, 因为识别数据较大,直接保存result超过字符长度限制

* 新增一个`fileIndex|`为前缀的的type,用来保存文件索引存储
* 新增词频, 修改新ocr识别结果

### 8. 媒体库三节保障梳理  - 

1. 以往数据参考, 给出需要多少机器, 多少倍的冗余,预估流量多少


## 已完成

1. medialib 接入佩奇 - 完成, 
    1. 单端口51827测试回归已过, 打包放量上线即可
    2. 排期: 10月26号上线

2. 三明治视频识别 - 完成
    1. mca新增一个function节点,处理用户标识(蓝V+F012)
    2. 排期: 10月27号上线
    
3. union 视频检索支持新的tag(中超联赛)
    1. 视频素材库支持新的tag即可 https://git.intra.weibo.com/im/dconfs-repo/-/merge_requests/2268
    2. 排期: 10月25号-10月27号,配合联调
    
4. acr 识别开关打开(dconfs开关控制) https://git.intra.weibo.com/im/dconfs-repo/-/merge_requests/2266/diffs 已完成

5. 非空的个人专辑统计 完成
    1. 视频集type=73
    2. 并且视频集下的item size 不能为空(该步骤需要开发)
    3. 排期: 11月1号提供产品所需统计数据

6. domainId bizid oid的作用
> `domainId:bizId+各个业务的id` 就代表一个oid,举例:oid=1022: 100101BSJK09
> 其中1022代表域, 100101就是业务号,BSJK09就是各个业务方自己的唯一id

1. domainId是和域名强相关,和对象库url字段的域名一一对应
2. 业务号是一串6位数字的id,用于区分接入到page体系的具体业务,两端用业务号来识别具体业务方,以及完成页面渲染等具体功能实现
    * 体现在URL上 `http://weibo.com/p/oid`,接入page的时候能从url上区分业务来源
    * feed卡片解析中通过业务号来识别,同一个业务号没办法解析出来两种卡片
    * 渲染对象的页面框架同样通过业务号来判断
    * 业务号不是用来区分业务方的,而是用来区分具体业务的,一个业务方(例如: 视频业务方)下边可能有多种业务(例如: 视频播放卡片, gif等)
### 本周周报

1. exchange同步dolby压标标识到对象库,并下发dolby相关图标
    * 进度: 测试通过,待上线
    * 11月9号 周三完成上线
2. 多维库数据结构定义,ocr, 视频分类存储格式定义
3. 媒体商单接入视频发博 doing   
    
    1. [x] 审核和审核方沟通 - 春晓已沟通,待反馈
    2. [x] 视频水印,微博视频号 - 佩文确认
    3. [x] 版权保护, 非自制能进,是否侵权别人 - 和美娇确认中
    4. [x] 删微博同时删媒体库 - 已完成
    5. [ ] 进profile视频签 - union队里机 https://git.intra.weibo.com/im/dconfs-repo/-/merge_requests/2310  待合代码
    6. [x] 关注流/赞流  - 经佳月确认,已经没有了
    7. [x] 投稿审核通过后进通知流 - 没有投稿行为,不存在此操作
    8. [ ] 可推荐  - 待春晓反馈
    9. [ ] 统计视频播放量 - log-processor是否有限制
    10. [ ] 统计作者播放量 - uid总播放量, 同视频签
    11. [ ] 统计分类标签播放量(分类页) - 不存在出口(春晓确认中)
    12. [ ] 统计播放量 (数据中心报表) - 春晓确认中

4. 媒体库三节保障梳理
    * 文档整理
    * 最终数据
     ```
     1.今年的日常峰值：23W
    2.去年的日常峰值：16W
    3.去年的元旦峰值：26.1W
    4.单台安全QPS：3000
    5.申请机器：(26.1/16*1.4*23)/0.3 - 72（常备）= 103
    申请18小时
     ```
     1.今年的日常峰值：18W
    2.去年的日常峰值：23W
    3.去年的元旦峰值：32.7W
    4.单台安全QPS：3000(java17+G1压测结果单机6300)
    5.申请机器：(32.7/23*1.4*18)/0.3 - 53（常备）= 67
    申请18小时
5. 排查新浪指纹数据延迟的问题, 机器学习侧堆积  导致收到的消息和产生消费时间差为10h
    * 优化单consumer 多线程处理的方式,提高性能
    * 指纹QPS  耗时 配置
6. 媒体库升级 data-mesh SDK
    * 本周四上线
7. 巡检搞一下, 新业务接入也配置下