## 视频无法入视频签问题总结
### 时间线

- 2023年2月5号 23:40  trigger 因上传涨量(日常的三倍,4.5k->13.5k) trigger服务端异常导致无法消费数据,写入正常
- 2023年2月6号 09:56  接故障反馈通知 从09:20开始发出的视频没有显示在视频页，累计共3例 [JIRA](http://jira.intra.sina.com.cn/browse/FAULTMANAGEMENT-21590)
- 2023年2月6号 10:03  @张鑫 发现video-union队列机无消费导致未入视频签,并联系魏强查看
- 2023年2月6号 10:24  @魏强 重启服务端,消费侧开始涨量,但无法消费历史数据
- 2023年2月6号 10:52  @魏强 开始尝试手动重置offset,消费历史数据
- 2023年2月6号 11:00  防止trigger无法重置offset, 准备备用方案: 重推历史数据. @建强 尝试从 dataworks 获取trigger 宕机期间全部的 MediaId, @张鑫 开始写洗数据脚本,根据mediaId构造媒体库trigger消息
- 2023年2月6号 11:46  @建强 @美娇 接故障管理4例新投诉,美娇,建强手动修复该4例用户的数据
- 2023年2月6号 11:57  @建强 dataworks查询媒体库hive表无法取到数据,开始尝试从exchange日志获取,文件过大,执行时间较长 
- 2023年2月6号 12:14  @魏强 反馈trigger丢失历史数据, 确认需要重新推送这批mediaId的事件
- 2023年2月6号 13:28  @县东 联系县东手动跑 5号21点至6号12点
- 2023年2月6号 13:56  @风麟 从上传捞取40万+mediaId
- 2023年2月6号 14:08  @张鑫 开始补推5号23点到6号上午11点的媒体库trigger数据
- 2023年2月6号 14:10  @县东 从hive表中捞数据完成
- 2023年2月6号 15:25  @张鑫 补推40万+数据成功,进行后续check逻辑
- 2023年2月6号 16:05  @建强 故障反馈新增三例投诉,其中两个无需修复,一个手动修复
- 2023年2月6号 17:32  @张鑫 补推数据check完成
### 已知影响范围:

- 发布视频未进入个人视频签 影响时间范围 2月5号23:40 - 2月6号10:28
- mca无法发起内容理解,无ASR发起,视频画质评分数据(推荐用)

### 改进措施

- trigger服务端监控 @魏强
    - 服务端新增四个关键的groupid的消费监控`video_management_media`,`snapvideo_medialib_msg`,`video_business_msg_medialib`,`media_content_analysis`
    - 迁移媒体库的trigger(具体是魏强进行操作,迁移ssd磁盘? 还是怎么做待确认??????)
    - 类似情况,能够保证多少小时的数据不丢失?
- 媒体库写入方监控 @建强
    - 目前写入流量监控已存在(本次媒体库写入监控正常)
    - 重做接口固化 - https://git.intra.weibo.com/im/medialib/-/merge_requests/1818 
    - 快速捞数据
        - 媒体库什么地方能快速捞出? mediaId+event
        - dataworks 难用,查不出来数据? @陈浩 @秦迪
- union队列机监控 @建强
    - 视频签探测报警: 探测内容为视频发布后能否在视频签接口查询到
    - union入视频签的延迟监控
    - 消费QPS流量突增突降探测

          