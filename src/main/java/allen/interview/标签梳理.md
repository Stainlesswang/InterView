# 标签梳理
`cpf_fmp_c22_feat_import_001` 营销平台数据标签引入c1-c8 

   什么是消费平台数据标签引入c1-c8????????
 `cpf_fmp_c_feat_import_check_002`营销平台数据标签引入c9-c14

---

###1.  **c1标签:**`cpf_fmp_c1_feat_import_001 ` 

  **标签含义: 注册时间（首次登录贷超距今多少天?1,3,7,14,30） 金融是否实名(是|否) 实名距今天数**

   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆	-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		

  
  - 表2:`kfpt_t_portal_user`

     `last_login_time`(最后登录时间)  `realname_auth_time`(实名认证时间)  `create_time`(创建时间,也就是首次登录的时间) 

  ```
 insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c1/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	 select 
	    t1.userid
	    ,case when  t2.recall_is_realauth is null then '3' else t2.recall_is_realauth  end as recall_is_realauth
	    ,case when  t2.recall_reg_time is null then '8' else t2.recall_reg_time  end as recall_reg_time  --注册时间（首次登录贷超）
	    ,case when  t2.recall_realauth_time is null then '8' else t2.recall_realauth_time  end as recall_realauth_time  
	from
	(
	
	    select 
	    userid
	    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
	    group by userid
	
	) t1
	left join 
	(
	select 
	user_id,
	case when realname_auth_time is not null then '1' else '2' end as recall_is_realauth,
	case when recall_reg_time=0 then '1' 
	when recall_reg_time=1 then '2' 
	when (recall_reg_time<=3 and recall_reg_time>1) then '3' 
	when (recall_reg_time<=7 and recall_reg_time>3) then '4' 
	when (recall_reg_time<=14 and recall_reg_time>7) then '5' 
	when (recall_reg_time<=30 and recall_reg_time>14) then '6' 
	when recall_reg_time>30 then '7' else '8' end as recall_reg_time,
	case  when recall_realauth_time=0 then '1'
	when recall_realauth_time=1 then '2'
	when (recall_realauth_time<=3 and recall_reg_time>1) then '3' 
	when (recall_realauth_time<=7 and recall_reg_time>3) then '4' 
	when (recall_realauth_time<=14 and recall_reg_time>7) then '5' 
	when (recall_realauth_time<=30 and recall_reg_time>14) then '6' 
	when recall_realauth_time>30  then '7' else '8' end as recall_realauth_time
	from
	(
	select
	user_id,
	realname_auth_time,
	datediff(${today},substr(create_time,1,10)) as recall_reg_time,
	datediff(${today},substr(realname_auth_time,1,10)) as recall_realauth_time
	from hdp_jinrong_qiangui_defaultdb.kfpt_t_portal_user 
	where daystr="$bash{date -d'${todaySuffix} -1 day ' +%Y%m%d}" 
	
	) t
	) t2 on t1.userid=t2.user_id;
  ```



###2.  **c2标签**`cpf_fmp_c2_feat_import_001 `

  **标签含义: 是否点击机构,机构点击次数(0,1,2-5,6-10,10次以上,未知)**

  - 表1: `stf_app_action_90d_001`

     90天活跃用户,userid,访问时间,来源,操作系统
  
  - 表2:`stf_kfpt_t_portal_order_001`

     ` org_id  `(机构id)  `phone `(电话)*该表首先以phone做Group,然后使用表三把phone映射成58id* 
     
  - 表3:`stf_idm_umc_md5_id2tel_001`(id到电话的映射表,left join以后将phone转为58id)

  
  ```
	 insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c2/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	select 
	userid
	,case when recall_org_click_times is null then '6' else recall_org_click_times end as recall_org_click_times
	,case when recall_org_click is null then '3' else recall_org_click end as recall_org_click
	from
	(
	    select 
	    userid
	    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
	    group by userid
	
	) t1
	left join 
	(
	select 
	userid as uid,
	case when recall_org_click_times=0 then '1' 
	when recall_org_click_times=1 then '2' 
	when (recall_org_click_times<=5 and recall_org_click_times>1) then '3' 
	when (recall_org_click_times<=10 and recall_org_click_times>5) then '4' 
	when recall_org_click_times>10 then '5' else '6' end as recall_org_click_times,
	case when org_id is not null then '1' 
	when org_id is null then '2' else '3' end as recall_org_click
	from 
	(
	select 
	phone,
	count(distinct org_id) as recall_org_click_times,
	max(org_id) as org_id
	from hdp_jinrong_qiangui_defaultdb.stf_kfpt_t_portal_order_001
	where daystr='$bash{date -d'${todaySuffix} -1 day' +%Y%m%d}'
	group by phone
	) t2
	left join 
	(
	
		select
			userid,
			tel
		from
			hdp_jinrong_qiangui_defaultdb.stf_idm_umc_md5_id2tel_001  --id2tel
		where
			daystr = '$bash{date -d'${todaySuffix} -3 day ' +%Y%m%d}'
	) t3
	on t2.phone=t3.tel
	where userid is not null and userid<>''
	) t4 on t1.userid=t4.uid ; 
  ```



###3.  **c3标签**`cpf_fmp_c3_feat_import_001 `


  **标签含义: 最近一次访问业务线(`new_type_ind` 1:招聘 2:租房 3:二手房 4:二手车 5:未知),最近一次访问业务距今时长(`biz_login_days` 1,2,3,4,5,6,7,8), 是否登录过金融**

 
  - 表1: `stf_app_action_90d_001`
       
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
  
 
  - 表2:`ctf_xfjr_history_user`

   	 字段名|中文名 
	--- | ---|
	58id |string	58id	
	mobile|string	手机号	
	`last_login_time`|string	最后登录时间
	`is_first_login`|string	是否首次登陆	-1:存量 0:非首次登陆 1:首次登陆
	client_os|string	客户端操作系统	
	daystr|string		

     
  - 表3:`user_profile_userid_extend`(金融画像数据,暂未找到)
 
  
 ```
	 insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c3/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	select 
	t1.userid,
	case when t4.new_type_ind is null then '5' else t4.new_type_ind end as new_type_ind,
	case when t1.login_time = 0 then '1'
	     when t1.login_time = 1 then '2'
	     when t1.login_time = 3 then '3' 
		 when t1.login_time = 7 then '4' 
		 when t1.login_time = 14 then '5'
		 when t1.login_time = 30 then '6'
		 when t1.login_time > 30 then '7'
		 else '8'
	end as biz_login_days,
	case when t3.58id is null then '0'
	     else '1' 
	end as is_login_gp
	from
	(
	     SELECT 
		userid,
		login_time
		FROM
	    (
	    select 
	    t1.userid as userid,
	    datediff(${today},to_date(from_unixtime(CAST(t1.timestamp/1000 as int),'yyyy-MM-dd HH:mm:ss'))) as login_time,
	    ROW_NUMBER() over (partition by t1.userid ORDER by 
						   to_date(from_unixtime(CAST(t1.timestamp/1000 as int),'yyyy-MM-dd HH:mm:ss')) desc )  as cnt
	    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 t1
	    where daystr='${todaySuffix}')t
	    where cnt = 1
	
	) t1
	left join 
	(
	select 
		userid as uid,
		case when new_type_ind='job' then '1' 
		when new_type_ind='rent' then '2' 
		when new_type_ind='house' then '3' 
		when new_type_ind='car' then '4' else '5' end as new_type_ind
	from
	(
	select 
			userid,
			max_data_cmpt(concat_ws(',',case when rent is null then '-' else rent end,case when job is null then '-' else job end,
			case when car is null then '-' else car end,case when house is null then '-' else house end), concat_ws(',','rent','job','car','house'),'-1') 
			as new_type_ind
		from(
			select
				userid,
				cast(unix_timestamp(t_rent_lasttimestamp) as string) as rent,
				cast(unix_timestamp(t_job_lasttimestamp) as string) as job,
				cast(unix_timestamp(t_car_lasttimestamp) as string) as car,
				cast(unix_timestamp(t_house_lasttimestamp) as string) as house
			from
				hdp_jinrong_qiangui_defaultdb.user_profile_userid_extend   --画像数据
			where
				daystr = "$bash{date -d'${todaySuffix} -2 day ' +%Y%m%d}"
	        ) t2 
	) t3
	) t4 
	on t1.userid=t4.uid
	left join
	(select
		58id
		from hdp_jinrong_qiangui_defaultdb.ctf_xfjr_history_user
		where daystr = '${dateSuffix}'
		group by 58id
	)t3
	on t1.userid = t3.58id;
 ```




###4.  **c4标签**`cpf_fmp_c4_feat_import_001 `


  **标签含义: 注册时间（pass注册时间 1到360天的时间区间**
  
  - 表1: `stf_app_action_90d_001`

           
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
  
  
 
  - 表2:`hdp_teu_dpd_defaultdb.ds_umc_info`(暂时未找到,用了reg_time字段)
 
  
 ```
	insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c4/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when new_reg_time is null then '12' else new_reg_time end as new_reg_time
from
(
    select 
    userid
    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
    group by userid
) t1
left join
(
    select 
    userid as uid,
    case when reg_time=0 then '1' 
    when reg_time=1 then '2' 
    when (reg_time<=3 and reg_time>1) then '3' 
    when (reg_time<=7 and reg_time>3) then '4' 
    when (reg_time<=14 and reg_time>7) then '5' 
    when (reg_time<=30 and reg_time>14) then '6' 
    when (reg_time<=60 and reg_time>30) then '7' 
    when (reg_time<=90 and reg_time>60) then '8' 
    when (reg_time<=180 and reg_time>90) then '9' 
    when (reg_time<=360 and reg_time>180) then '10' 
    when reg_time>360 then '11' else '12' end as new_reg_time
    from
    (
        select 
        userid,
        datediff(${today},substr(max(reg_time),1,10)) as reg_time
        from hdp_teu_dpd_defaultdb.ds_umc_info
        where ds='umc' group by userid
    ) t0
) t3
on t1.userid=t3.uid;
```




###5. **c5标签**`cpf_fmp_c5_feat_import_001 `


  **标签含义: 设备类型,活跃时长(1,3,7,14,30,30天以上,未知),用户来源**

  - 表1: `stf_app_action_90d_001`

           
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
  

  
 
 ```
	 insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c5/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when os_sys in('1','Android') then '1' 
when os_sys='3' then '2' else '3' end as new_os_sys,
case when source='m' then '2' 
when source='app' then '1' else '3' end as new_source_from,
case when timestamp=0 then '1' 
when timestamp=1 then '2' 
when (timestamp<=3 and timestamp>1) then '3' 
when (timestamp<=7 and timestamp>3) then '4' 
when (timestamp<=14 and timestamp>7) then '5' 
when (timestamp<=30 and timestamp>14) then '6' 
when timestamp>30  then '7' else '8' end as new_active_time
from 
(
select 
userid,
os_sys,
source,
datediff(${today},substr(from_unixtime(cast(timestamp/1000 as bigint),'yyyy-MM-dd HH:mm:ss'),1,10)) as timestamp,
row_number() over ( partition by userid order by source asc, timestamp desc) time_seq
--ROW_NUMBER() over (PARTITION by userid ORDER BY timestamp desc) as time_seq
--datediff(${today},substr(from_unixtime(substr(timestamp,1,10),'yyyy-MM-dd HH:mm:ss'),1,10)) as timestamp
--如果报错使用'${today}'
from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
) t where t.time_seq=1;
```




###6. **c6标签**`cpf_fmp_c6_feat_import_001 `


  **标签含义: 是否贷超注册(1是,2否),黑名单(1:是 2否)**

    
   - 表1: `stf_app_action_90d_001`

          
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
     
   - 表2:`stf_idm_umc_md5_id2tel_001`(id到电话的映射表,left join以后将phone转为58id)
   - 表3 `xfjr_black_phone1` 黑名单电话表 phone字段
   - 表4:`kfpt_t_portal_user`

     `last_login_time`(最后登录时间)  `realname_auth_time`(实名认证时间)  `create_time`(创建时间,也就是首次登录的时间) 

  
 
	```
		insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c6/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	select 
	userid,
	case when phone is not null then '1' else '2' end as recall_risk_label,
	--case when phone is not null then '1' else '2' end as new_risk_label,
	case when (user_id is not null or phone_2 is not null) then '1' else '2' end as register  --是否注册贷超
	from 
	(
	select 
	p0.userid as userid,
	max(p4.phone) as phone,
	max(p5.user_id) as user_id,
	max(p6.phone) as phone_2
	from 
	(
	    select 
	    userid
	    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
	    group by userid
	    
	) p0
	left join
	(
	    select
	        userid as uid,
	        tel
	    from
	        hdp_jinrong_qiangui_defaultdb.stf_idm_umc_md5_id2tel_001  --id2tel
	    where
	        daystr = "$bash{date -d'${todaySuffix} -3 day ' +%Y%m%d}"
	) p1 on p0.userid=p1.uid
	left join
	(
	    select 
	        phone
	    from hdp_jinrong_qiangui_defaultdb.xfjr_black_phone1
	) p4
	on p1.tel = p4.phone
	left join
	(
	    select
	        user_id,
	        phone
	    from 
	        hdp_jinrong_qiangui_defaultdb.kfpt_t_portal_user 
	    where 
	        daystr = "$bash{date -d'${todaySuffix} -1 day ' +%Y%m%d}" 
	) p5
	on p0.userid = p5.user_id
	left join
	(
	    select
	        user_id,
	        phone
	    from 
	        hdp_jinrong_qiangui_defaultdb.kfpt_t_portal_user 
	    where 
	        daystr = "$bash{date -d'${todaySuffix} -1 day ' +%Y%m%d}"  
	) p6
	on p1.tel = p6.phone
	group by p0.userid
	
	) t;
	```




###7. **c7标签**`cpf_fmp_c7_feat_import_001 `


  **标签含义: 资产状况(月收入区间) 身份属性(年龄,教育程度,工作地点及年限,账户认证类型) 设备属性(系统及价格)**

    
   - 表1: `stf_app_action_90d_001`
       
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
     
   - 表2 `sft_user_fsmart_label_001` 用户的工作年限,性别及受教育程度等信息
   - 表3 `stf_usr_dc2_xfjr_realname` 用户的信息,身份证号等,此处根据身份证号得到年龄区间属性

    ```			
	ADD JAR hdfs://hdp-58-cluster/home/hdp_58dp/udf/PhoneHash.jar;
		CREATE TEMPORARY FUNCTION P2PGetAge AS 'com.bj58.P2PGetAge';
		--SELECT P2PGetAge(NULL)
		ADD JAR hdfs://hdp-58-cluster/home/hdp_58dp/udf/fbuudf_170801.jar;
		CREATE TEMPORARY FUNCTION fbu_decode_trans AS 'com.bj58.fbuudf.trans.DeCoderTransOtherUdf';
		
		dfs -mkdir -p /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c7/${todaySuffix};
		dfs -rm -r /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c7/${todaySuffix};
		
		insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c7/${todaySuffix}'
		ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
		select 
		userid
		,case when new_equip_price is null then '8' else new_equip_price end as new_equip_price
		,case when new_realauth_type is null then '3' else new_realauth_type end as new_realauth_type
		,case when jr_loan_agent='1' then '1' else '3' end as jr_loan_agent
		,case when new_income_comp is null then '8' else new_income_comp end as new_income_comp
		,case when new_gender is null then '3' else new_gender end as new_gender
		,case when new_education is null then '6' else new_education end as new_education
		,case when new_workedyears is null then '7' else new_workedyears end as new_workedyears
		,case when jr_new_age_interval is not null then jr_new_age_interval
		      when jr_new_age_interval is null and new_age_interval is null then '8'
		      else new_age_interval end as new_age_interval
		--,case when new_age_interval is null then '8' else new_age_interval end as new_age_interval
		--,case when new_equip_brand is null then '28' else new_equip_brand end as new_equip_brand
		,case when new_equip_model is null then '300' else new_equip_model end as new_equip_model
		--,case when new_native_province is null then '32' else new_native_province end as new_native_province
		,case when new_native_city is null then '339' else new_native_city end as new_native_city
		--,case when new_work_province is null then '32' else new_work_province end as new_work_province
		,case when new_workplace is null then '339' else new_workplace end as new_workplace
		,case when t3.58id is not null then '1' else '0' end as is_jr_realname_usr
		from 
		(
		
		    select 
		    userid
		    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
		    group by userid
		
		) t1
		left join 
		(
		select 
		userid as uid
		,new_equip_price
		,new_realauth_type
		,jr_loan_agent
		,new_income_comp
		,new_gender
		,new_education
		,new_workedyears
		,new_age_interval
		--,new_equip_brand
		,new_equip_model
		--,new_native_province
		,new_native_city
		--,new_work_province
		,new_workplace
		from hdp_jinrong_qiangui_defaultdb.sft_user_fsmart_label_001
		where daystr='20190401'
		
		) t2
		on t1.userid=t2.uid
		left join 
		(
		select 
		58id,
		case when P2PGetAge(fbu_decode_trans(id_card))<20 then "1"
		     when P2PGetAge(fbu_decode_trans(id_card))>=20 and P2PGetAge(fbu_decode_trans(id_card)) <=25 then "2"
		     when P2PGetAge(fbu_decode_trans(id_card))>=26 and P2PGetAge(fbu_decode_trans(id_card)) <=30 then "3"
		     when P2PGetAge(fbu_decode_trans(id_card))>=31 and P2PGetAge(fbu_decode_trans(id_card)) <=35 then "4"
		     when P2PGetAge(fbu_decode_trans(id_card))>=36 and P2PGetAge(fbu_decode_trans(id_card)) <=40 then "5"
		     when P2PGetAge(fbu_decode_trans(id_card))>=41 and P2PGetAge(fbu_decode_trans(id_card)) <=45 then "6"
		     when P2PGetAge(fbu_decode_trans(id_card))>45 then "7"
		else "8" end as jr_new_age_interval
		from  hdp_jinrong_qiangui_defaultdb.stf_usr_dc2_xfjr_realname WHERE daystr='${dateSuffix}'  and fbu_decode_trans(id_card) is not null  
		)t3
		on t1.userid=t3.58id
```

###8. **c8标签**`cpf_fmp_c8_feat_import_001 `


  **标签含义: 消费金融意向登记**

    
   - 表1: `stf_app_action_90d_001`

           
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
  
 
   
   - 表2 `stf_idm_umc_md5_id2tel_001` 58id和电话的转换表
   - 表3 `itf_models_output_score_001` 金融意向主要使用了data字段,详细见SQL代码中对等级的分级

     
     ```	
     insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c8/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when min(response_level) is null then '11'
else  min(response_level) end as response_level
from 
(
    select 
        userid
    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
    group by userid
) t1
left join
(
    select 
        userid as uid,
        tel
    from hdp_jinrong_qiangui_defaultdb.stf_idm_umc_md5_id2tel_001
    where daystr='$bash{date -d'${todaySuffix} -3 day ' +%Y%m%d}'
) t2 on t1.userid=t2.uid 
left join 
(
select
	uid as phone,
	case when data > 0.0255 and data <= 1 then '10' 
		 when data > 0.0196 and data <= 0.0255 then '9'
		 when data > 0.0162 and data <= 0.0196 then '8'
		 when data > 0.0125 and data <= 0.0162 then '7'
		 when data > 0.0115 and data <= 0.0125 then '6'
		 when data > 0.0102 and data <= 0.0115 then '5'
		 when data > 0.00865 and data <= 0.0102 then '4'
		 when data > 0.00767 and data <= 0.00865 then '3'
		 when data > 0.00695 and data <= 0.00767 then '2'
		 when data >= 0 and data <= 0.00695 then '1'
	end as response_level
from hdp_jinrong_qiangui_defaultdb.itf_models_output_score_001
where model_name='xjd_response_v7' and daystr = "$bash{date -d'${todaySuffix} -2 day ' +%Y%m%d}"
) t3 on t2.tel=t3.phone
group by userid;	
 ```


###9. **c9标签**`cpf_fmp_c9_feat_import_001 `


  **标签含义:是否实名(1是 2否 3未知)**

    
   - 表1: `stf_app_action_90d_001`

           
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
     
   - 表2 `stf_user_fup_001` jr_is_realauth字段是否实名认证字段

     
     ```	
     insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c9/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when jr_is_realauth='1' then '1' 
when jr_is_realauth='0' then '2'  else '3' end as new_is_realauth
from 
(
select 
userid
from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
group by userid
) t1
left join 
(
select 
userid as uid,
jr_is_realauth
from hdp_jinrong_qiangui_defaultdb.stf_user_fup_001
where daystr='20190430'
) t2
on t1.userid=t2.uid
; 
```


###10. **c10标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

            
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
     
    - 表2 `itf_xfjr_dm_wmda_log_ev_3289916654594` 该表代表什么兄弟 还不知道

     
     ```	
		     insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c10/${todaySuffix}'
		ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
		select 
		userid,
		case when recall_source is null then '19' else recall_source end as recall_source
		from 
		(
		
		    select 
		    userid
		    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
		    group by userid
		
		) t1
		left join 
		(
		select 
		    user_id,
		    case when ad_source='58_app_index_new' then '1'
		    when ad_source='58_app' then '2'
		    when ad_source='xxh' then '3'
		    when ad_source='58_app_syzr' then '4'
		    when ad_source='58_app_esc_fzx_detail' then '5'
		    when ad_source='58_haojie' then '6'
		    when ad_source='58_app_index' then '7'
		    when ad_source='58_app_huoche_detail' then '8'
		    when ad_source='58_app_fenlei' then '9'
		    when ad_source='58_app_index_jsq' then '10'
		    when ad_source='58_app_home' then '11'
		    when ad_source='58_wx_tc1' then '12'
		    when ad_source='ganji_m_zufang_detail' then '13'
		    when ad_source='ganji_app_zufang_detail' then '14'
		    when ad_source='58_m_esc_index' then '15'
		    when ad_source='wddk' then '16'
		    when ad_source='ganji_app_esf_detail1' then '17'
		    when ad_source='58_m_esc_guchejia' then '18'
		    else '19' end as recall_source
		from 
		    (
		    select 
		    user_id,
		    ad_source,
		    dt_ts_event,
		    row_number() over ( partition by user_id order by dt_ts_event desc) num
		    from hdp_jinrong_qiangui_defaultdb.itf_xfjr_dm_wmda_log_ev_3289916654594
		    where daystr='$bash{date -d'${todaySuffix} -1 day ' +%Y%m%d}'
		    ) t  where t.num=1
		) t2 
		on t1.userid=t2.user_id;
     ```

###11. **c11标签**`cpf_fmp_c11_feat_import_001 `


  **标签含义:手机号运营商(移动,联通,电信,未知) **

    
   - 表1: `stf_app_action_90d_001`
            
      字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
  
   
    - 表2 `stf_idm_umc_md5_id2tel_001` uid转换为tel的表 使用了UDF来自定义根据手机号
     
    ```	
	ADD JAR hdfs://hdp-58-cluster/home/hdp_58dp/udf/fbuudf-1.0.0.0..jar;
	CREATE TEMPORARY FUNCTION fbu_phone_2_city AS 'com.bj58.fbuudf.phone2city.Phone2CityUdf';
		
		
	dfs -mkdir -p /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c11/${todaySuffix};
	dfs -rm -r /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c11/${todaySuffix};
		
	insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c11/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	select 
	userid,
	case when cardtype='移动' then '1' 
	when cardtype='联通' then '2' 
	when cardtype='电信' then '3' else '4' end as recall_cardtype
	from 
	(
		    select 
		    userid
		    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
		    group by userid
	) t1 
	left join 
	(
		select
			userid as uid,
		       split(fbu_phone_2_city(tel),',')[5] as cardtype
		from
			hdp_jinrong_qiangui_defaultdb.stf_idm_umc_md5_id2tel_001  --id2tel
		where
			daystr = '$bash{date -d'${todaySuffix} -3 day ' +%Y%m%d}'
	) t2
	on t1.userid=t2.uid; 
    ```


###12. **c12标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
   
   - 表2 `itf_dc_db58_consumeuser_user_view` 58id以及用户的身份证详细信息 使用了UDF解码方法

     
```	
     ADD JAR hdfs://hdp-58-cluster/home/hdp_58dp/udf/fbu-udf-170911xu.jar;
CREATE TEMPORARY FUNCTION fbu_decode_xffq AS 'com.bj58.fbuudf.date.DeCoderTransXFFQUdf';


dfs -mkdir -p /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c12/${todaySuffix};
dfs -rm -r /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c12/${todaySuffix};


insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c12/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when (wb_id is not null and id_card is not null) then '1'
when (wb_id is not null and id_card is null) then '2' 
when wb_id is null then '3' end as recall_id_verify
from 
(
    select 
    userid
    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
    group by userid

) t1
left join
(
    select  
        wb_id,
        fbu_decode_xffq(id_card) as id_card
    from hdp_jinrong_qiangui_defaultdb.itf_dc_db58_consumeuser_user_view 
    where daystr='$bash{date -d'${todaySuffix} -1 day ' +%Y%m%d}'
) t2
on t1.userid=t2.wb_id;
		  
```


    

###14. **c14标签**`cpf_fmp_c14_feat_import_001 `


  **标签含义:营销次数,最后一次营销距今时长**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
	   --- | ---|
		userid |string	58id	
		os_sys |string	操作系统	
		source |string	来源	
		timestamp |string	访问时间
		daystr|string		
   
   - 表2 `stf_user_fsmart_feedback_001` 58id,手机号,imei,营销时间,type(待确认)

     
```
insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c14/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
userid,
case when (send_times is null or send_times=0) then '1'
when send_times=1 then '2'
when send_times=2 then '3'
when send_times=3 then '4'
when send_times=4 then '5'
when send_times>4 then '6'
end as new_send_times,
case when last_send_time=0 then '1'
when last_send_time=1 then '2'
when (last_send_time>1 and last_send_time<=3) then '3'
when (last_send_time>3 and last_send_time<=7) then '4'
when (last_send_time>7 and last_send_time<=14) then '5'
when (last_send_time>14 and last_send_time<=30) then '6'
when last_send_time>30 then '7'
else '8'
end as new_last_send_time 
from 
(

    select 
    userid
    from hdp_jinrong_qiangui_defaultdb.stf_app_action_90d_001 where daystr='${todaySuffix}'
    group by userid

) t1
left join 
(
   select 
      userid as uid,
      count(1) as send_times,
      datediff(${today},max(time)) as last_send_time 
   from hdp_jinrong_qiangui_defaultdb.stf_user_fsmart_feedback_001
   where type in('imei','phone','userid') group by userid
) t2 on t1.userid=t2.uid;
```


    

###16. **c16标签**`cpf_fmp_c16_feat_import_001 `


  **标签含义:全部金融用户的生命周期,分为行为属性(有优先级)以及时间属性**
  
  行为属性:根据用户登录认证授信用信的从低到高的优先级来给用户价格标签,看看用户走到哪个阶段了
  
  
  时间属性:主要是各种次数的属性,看看用户的行为次数

    
   - 表1: `ctf_xfjr_history_user`  (金融全量用户)

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		
   
    - 表2 `stf_user_xfjr_life_cycle_001` 消费金融生命周期表

     
     ```	
		 略(请到58DP任务查看详情,太长了) 
     ``` 

###17. **c17标签**`cpf_fmp_c17_feat_import_001 `


  **标签含义:集团smart标签**

    
   - 表1: `stf_user_smart_variable_001` 直接从该表中查出的数据就可以满足么?

     
```	
insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c17/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
regexp_replace(userid,'wuser|-','')
,t_dispcate_1_90d
,visit_active
,p_poster_agenttype_90d
,job_benefit_90d
,resume
,rent_price_range_90d
,rent_hire_type_90d
,car_price_range_90d
,58che_app_chexi_price_range_90d
,ajk_price_xf_90d
from hdp_jinrong_qiangui_defaultdb.stf_user_smart_variable_001
where daystr=${todaySuffix}
;	  
``` 

###18. **c18标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `ctf_xfjr_haojie_user_class_001`

     字段名|中文名 
		--- | ---|
		wb_id |int	是否有授信通过,1:有，0:无
		haswithdrawapplycurrcredit |int	最新的授信是否有发起过提现申请,1:有，0:无
		`is_credit_valid `|int	是否在最新授信通过的有效期内,-1:未知,1:是,0:否	
		`vist_dur_seg `|int	用户的最近访问时间，包括访问贷超和好借,距离当前的天数分段,-1(未知),0,1,2,3,4,5,6,7,9999(其他)
		`credit_dur_seg` |int	最新授信通过的授信时间距离当前的天数分段，-1(未知),14,21,30,35,49,56,60,63,70,77,84,89,9999(其他)	
	daystr|string		
  
```	 
insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c18/${todaySuffix}'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
select 
regexp_replace(wb_id,'wuser|-','')
,hasCredit
,hasWithDrawApplyCurrCredit
,is_credit_valid
,vist_dur_seg
,credit_dur_seg
from hdp_jinrong_qiangui_defaultdb.ctf_xfjr_haojie_user_class_001
where daystr=${dateSuffix}
;
```             

###18. **c18标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		
   
    - 表2 `itf_xfjr_dm_wmda_log_ev_3289916654594` 该表代表什么兄弟

     
     ```	
		  
     ``` 


###18. **c18标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		
   
    - 表2 `itf_xfjr_dm_wmda_log_ev_3289916654594` 该表代表什么兄弟

     
     ```	
		  
     ``` 
###18. **c18标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		
   
    - 表2 `itf_xfjr_dm_wmda_log_ev_3289916654594` 该表代表什么兄弟

     
     ```	
		  
     ``` 
###18. **c18标签**`cpf_fmp_c10_feat_import_001 `


  **标签含义:最近一次信息渠道来源(1-19分别代表不同的渠道)**

    
   - 表1: `stf_app_action_90d_001`

     字段名|中文名 
		--- | ---|
		58id |string	58id	
		mobile|string	手机号	
		`last_login_time`|string	最后登录时间	
		`is_first_login`|string	是否首次登陆-1:存量 0:非首次登陆 1:首次登陆
		client_os|string	客户端操作系统	
		daystr|string		
   
    - 表2 `itf_xfjr_dm_wmda_log_ev_3289916654594` 该表代表什么兄弟

     
     ```	
		  
     ``` 
###22. `cpf_fmp_c22_feat_import_001`  好借召回标签（申请好借，最后一次登陆距今时长）


  - 表1:`ctf_xfjr_history_user`

 字段名|中文名 
--- | ---|
58id |string	58id	
mobile|string	手机号	
`last_login_time`|string	最后登录时间	
`is_first_login`|string	是否首次登陆	-1:存量 0:非首次登陆 1:首次登陆
client_os|string	客户端操作系统	
daystr|string		
	
  - 表2:`hdp_jinrong_qiangui_defaultdb.ctf_fk_xfjr_quota_application_001 `

 字段名|中文名 
--- | ---|
`etl_load_time`|string	ETL加载时间	
source_id|string	源表主键：`t_mulan_apply.id`	
`quota_apply_no`|string	额度申请编号	
customer_id|string	客户id	
contract_no|string	合同编号	
apply_time|string	申请时间	进件到风控系统时间
apply_status|string	申请状态	申请状态1000:申请中，3000:审核中，3900:审核拒绝，4000:审核通过
apply_progress|string	申请进度	
`apply_complete_time`|string	申请完成时间	
audit_result|string	审核结果0：通过，-1：拒绝	
`audit_complete_time`|string	审批完成时间	
audit_quota|decimal(24,8)	审批额度	
`quota_valid_period_array`|string	额度有效期数组	
`loan_term_cnt_array`|string	贷款期数数组	
`term_rate_array`|string	分期费率数组	
`first_repay_interval_days_array`|string	首期还款日时间间隔数组	
`price_code_array`|string	定价组合编码数组	
refuse_period|string	拒绝有效期	
create_time|string	创建时间	
update_time|string	更新时间	
`realname_audit_time`|string	实名认证完成时间	
`setup_password_time`|string	设置交易密码完成时间	
`living_audit_time`|string	活检完成时间	
`core_expire_date`|string	核心额度有效期	yyyy-mm-dd
type|string	申请类型，0:好借自营，1:轻授信	
credit_refuse_expired_time|string	授信拒绝到期时间
fund|string	资方	
src_location|string	来源位置	
daystr|string		

 
	```HQL
	set mapreduce.job.reduces=500;
	set hive.auto.convert.join = true;
	set hive.exec.parallel=true;
	
	dfs -mkdir -p /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c22/${todaySuffix};
	dfs -rm -r /home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c22/${todaySuffix};
	
	insert overwrite directory '/home/hdp_jinrong_qiangui/resultdata/fsmart/fsmart_data_import/c22/${todaySuffix}'
	ROW FORMAT DELIMITED FIELDS TERMINATED BY '\001'
	select 
	t1.58id as userid,
	case WHEN t1.login_time=0 then '1'
	     when t1.login_time=1 then '2'
	     when t1.login_time=3 then '3'
	     when t1.login_time=7 then '4'
	     when t1.login_time=14 then '5'
	     when t1.login_time=30 then '6'
	else '7' end as last_login_time,
	case when t2.customer_id is not null then '1'
	else '0' end as is_apply_user
	from 
	(
	select 
	58id,
	datediff(${today},to_date(last_login_time)) as login_time
	from  hdp_jinrong_qiangui_defaultdb.ctf_xfjr_history_user  where daystr='${dateSuffix}' 
	)t1
	left join 
	(
	select
	customer_id
	from hdp_jinrong_qiangui_defaultdb.ctf_fk_xfjr_quota_application_001  where daystr='${dateSuffix}' group by customer_id
	)t2
	on t1.58id=t2.customer_id
	```
	
	
	